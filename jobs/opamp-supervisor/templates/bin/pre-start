#!/bin/bash
set -e

# Pre-start script to set up instance UUID for OpAMP supervisor
# Uses BOSH instance ID from /var/vcap/instance/id as the OpAMP instance UUID
# The supervisor reads instance_id from persistent_state.yaml on startup

STORAGE_DIR="<%= p('storage_dir') %>"
PERSISTENT_STATE_FILE="${STORAGE_DIR}/persistent_state.yaml"
BOSH_INSTANCE_ID_FILE="/var/vcap/instance/id"

# Create storage directory if it doesn't exist
mkdir -p "${STORAGE_DIR}"

# Read BOSH instance ID (which is already a UUID)
if [ ! -f "${BOSH_INSTANCE_ID_FILE}" ]; then
    echo "Error: BOSH instance ID file not found at ${BOSH_INSTANCE_ID_FILE}"
    exit 1
fi

INSTANCE_UUID=$(cat "${BOSH_INSTANCE_ID_FILE}" | tr -d '[:space:]')

# Validate UUID format (basic check)
if ! echo "${INSTANCE_UUID}" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
    echo "Error: BOSH instance ID '${INSTANCE_UUID}' is not in valid UUID format"
    exit 1
fi

# Update or create persistent_state.yaml with the instance UUID
# The supervisor reads instance_id from this file on startup
if [ -f "${PERSISTENT_STATE_FILE}" ]; then
    # Update existing file - preserve other fields if they exist
    if grep -q "^instance_id:" "${PERSISTENT_STATE_FILE}"; then
        # Update existing instance_id
        sed -i "s/^instance_id:.*/instance_id: ${INSTANCE_UUID}/" "${PERSISTENT_STATE_FILE}"
        echo "Updated instance_id in ${PERSISTENT_STATE_FILE} to ${INSTANCE_UUID}"
    else
        # Add instance_id at the beginning, preserve rest of file
        {
            echo "instance_id: ${INSTANCE_UUID}"
            cat "${PERSISTENT_STATE_FILE}"
        } > "${PERSISTENT_STATE_FILE}.tmp"
        mv "${PERSISTENT_STATE_FILE}.tmp" "${PERSISTENT_STATE_FILE}"
        echo "Added instance_id to ${PERSISTENT_STATE_FILE}: ${INSTANCE_UUID}"
    fi
else
    # Create new file with instance_id
    cat > "${PERSISTENT_STATE_FILE}" <<EOF
instance_id: ${INSTANCE_UUID}
last_remote_config_status: null
EOF
    echo "Created ${PERSISTENT_STATE_FILE} with instance_id: ${INSTANCE_UUID}"
fi

echo "Instance UUID setup complete: ${INSTANCE_UUID}"

